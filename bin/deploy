#!/bin/bash

# Builds the application, uploads it to the server, and restarts the daemon.

set -e -x

ROOT=/srv/go
HASH=$(git rev-parse --short=7 HEAD)
DIR=$ROOT/rel/$HASH
TMP=/tmp/gogo-$HASH.tar.gz

pushd ..
	tar --exclude=".*" -czf gogo.tar.gz gogo
	scp -i gogo/.etc/id_ecdsa -o StrictHostKeyChecking=no gogo.tar.gz dylan@go.waits.io:$TMP
	rm gogo.tar.gz
popd

ssh -i .etc/id_ecdsa -o StrictHostKeyChecking=no dylan@go.waits.io <<-EOF
	set -e -x

	echo "Unpacking..."
	mkdir -p $DIR
	tar -xzf $TMP -C $DIR --strip-components=1

	echo "Saving database snapshot..."
	$DIR/bin/backup

	echo "Updating symlink..."
	ln -nsf $DIR $ROOT/cur
	sudo service go restart

	echo "Cleaning up old releases..."
	rm $TMP
	cd $ROOT/rel && ls -t | tail -n +6 | xargs rm -rf

	echo "Done!"
EOF
